name: Auto close pull requests

on:
  pull_request_target:
    types: [opened, labeled, unlabeled, reopened]

jobs:
  auto_close:
    runs-on: ubuntu-latest

    steps:
    - name: Install GitHub CLI
      run: |
        set -e
        sudo apt-get update
        sudo apt-get install -y curl apt-transport-https ca-certificates gnupg
        curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
        sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
        echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
        sudo apt-get update
        sudo apt-get install -y gh

    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Close PR if not pre-approved
      if: ${{ !(contains(github.event.pull_request.labels.*.name, 'pre-approved')) && !(contains(github.event.pull_request.body, '@alfredodeza')) }}
      shell: bash
      run: |
        MESSAGE="This repository doesn't accept pull requests. Please fork the repository and make changes there. If you really need this PR to be merged you must be an admin and label this PR with the 'pre-approved' label *or* tag Alfredo Deza (\`@alfredodeza\`) to take a look."

        # Get PR number from event
        PR_NUMBER="${{ github.event.pull_request.number }}"

        echo "Event PR number: '$PR_NUMBER'"

        # If empty ‚Üí fetch from GitHub API (works for fork PRs)
        if [ -z "$PR_NUMBER" ]; then
          echo "‚ö† PR number missing ‚Äî fetching manually..."
          PR_NUMBER=$(gh pr list --state open --json number --jq '.[0].number')
        fi

        echo "üìå Using PR number: $PR_NUMBER"

        # Safety: if STILL empty, abort gracefully instead of failing
        if [ -z "$PR_NUMBER" ]; then
          echo "‚ùå ERROR: Unable to determine PR number. Exiting safely."
          exit 0
        fi

        # Close the PR
        gh pr close "$PR_NUMBER" --repo ${{ github.repository }} --comment "$MESSAGE"

      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
