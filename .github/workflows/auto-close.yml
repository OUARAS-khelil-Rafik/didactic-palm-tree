name: Auto close pull requests

on:
  pull_request_target:
    types: [opened, labeled, unlabeled, reopened]

jobs:
  auto_close:
    runs-on: ubuntu-latest

    steps:
    - name: Install GitHub CLI
      uses: cli/cli@v2

    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Close PR if not pre-approved
      shell: bash
      run: |
        MESSAGE="This repository doesn't accept pull requests. Please fork the repository and make changes there. If you really need this PR to be merged you must be an admin and label this PR with the 'pre-approved' label *or* tag Alfredo Deza (\`@alfredodeza\`) to take a look."

        PR_NUMBER="${{ github.event.pull_request.number }}"

        # Exit safely if no PR exists
        if [ -z "$PR_NUMBER" ]; then
          echo "âš  No PR number detected. Nothing to close. Exiting safely."
          exit 0
        fi

        # Only close if the PR does not have the pre-approved label or mention
        LABELS="${{ github.event.pull_request.labels.*.name }}"
        BODY="${{ github.event.pull_request.body }}"
        if [[ ! "$LABELS" =~ "pre-approved" && ! "$BODY" =~ "@alfredodeza" ]]; then
          echo "ðŸ“Œ Closing PR #$PR_NUMBER"
          gh pr close "$PR_NUMBER" --repo ${{ github.repository }} --comment "$MESSAGE"
        else
          echo "âœ… PR #$PR_NUMBER is pre-approved or mentions @alfredodeza. Skipping close."
        fi
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
