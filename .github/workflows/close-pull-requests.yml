name: Auto close pull requests

on:
  pull_request_target:
    types: [opened, labeled, unlabeled, reopened]

jobs:
  auto_close:
    runs-on: ubuntu-latest

    steps:
    - name: Install GitHub CLI
      uses: cli/cli@v2

    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Close PR if not pre-approved
      if: ${{ !(contains(github.event.pull_request.labels.*.name, 'pre-approved')) && !(contains(github.event.pull_request.body, '@alfredodeza')) }}
      run: |
        MESSAGE="This repository doesn't accept pull requests. Please fork the repository and make changes there. If you really need this PR to be merged you must be an admin and label this PR with the 'pre-approved' label *or* tag Alfredo Deza (\`@alfredodeza\`) to take a look."

        # Load PR number from event payload
        PR_NUMBER="${{ github.event.pull_request.number }}"

        # If the PR number is missing (happens with forks), retrieve it manually
        if [ -z "$PR_NUMBER" ]; then
          echo "âš  Event PR number is empty â€” fetching the PR number manually..."
          PR_NUMBER=$(gh pr list --state open --json number --jq '.[0].number')
        fi

        echo "ðŸ“Œ Closing PR #$PR_NUMBER in repository: ${{ github.repository }}"

        # Close the pull request
        gh pr close "$PR_NUMBER" --repo ${{ github.repository }} --comment "$MESSAGE"

      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}